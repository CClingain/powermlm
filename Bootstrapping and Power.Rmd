---
title: "Bootstrapping and Power"
author: "Clare Clingain"
date: "November 7, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(lmerTest)
library(powermlm)
library(doParallel)
classroom <- read.csv("C:/Users/Clare/Documents/Spring 2018 Multi-level Modeling Nested Data/classroom.csv", stringsAsFactors = T)
```

# Bootstrapping vs. Simulation

Bootstrapping involves generating a new sample from the given data as opposed to simuation, which generates new data based on the specified DGP with known parameters. Given that one has the data for a post-hoc power analysis, bootstrapping would maintain the grouping structure and allows one to see the fitting of the parameters for each resampling. Bootstrapping is also more robust to uneven group sizes, such that resampling can be done within a specific group, and the *n* can be set for each group. Thus, if we wished to obtain the power of a fixed effect, *X*, we can bootstrap 1,000 samples, run our model, extract the parameter value and the p-values for each iteration, and examine the proportion of times we reject the null hypothesis that *X* is 0. 

# Testing the bootmlm2 function

We generate fake data with students nested within schools to test the efficacy of the bootmlm2 function, which can bootstrap data with 2 levels (i.e., students within schools). 

```{r}
# Generate fake data
set.seed(123)
dat <- cbind.data.frame(rnorm(100,0,1), rnorm(100,10,2), 1:100, rep(1:5, 20))
colnames(dat) <- c("X","Y","ID","schoolid")
# Test function
dat2 <-bootmlm2(id = "ID", group1 = "schoolid", data = dat)
head(dat2)
```

# Testing the bootmlm function

The difference between the bootmlm and bootmlm2 function si that the bootmlm function is robust to data with up to 3 levels. That is, we can bootstrap students within classrooms within schools. 

## 2 levels of nesting

```{r bootmlm test with 2 levels}
set.seed(123)
dat2b <- bootmlm(id = "ID", group1 = "schoolid", group2 = FALSE, data = dat)
head(dat2b)
```

## 3 levels of nesting

```{r bootmlm test with 3 levels}
# Generate fake data with 3-levels
set.seed(123)
dat3 <- cbind.data.frame(rnorm(100,0,1), rnorm(100,10,2), 1:100, rep(1:5, 20), rep(1:5, each = 20))
colnames(dat3) <- c("X", "Y", "ID", "schoolid", "classid")
# Test function 
dat4 <- bootmlm(id = "ID", group1 = "classid", group2 = "schoolid", data = dat3)
head(dat4)
```

## Missing Data

One of the stipulations of these two functions is that there cannot be any missing data in the grouping IDs. However, the functions are able to replicate datasets with missing data.
The purpose of this package does not include missing data imputation. In a later version, it would be ideal to add this feature. 

## Single Power Estimate

```{r}
pow.est <- boot.power(model = Y~X + (1|schoolid), n = 100, id = "ID", group1 = "schoolid", group2 = FALSE, data = dat)
pow.est
```

### Parallelized version

```{r}
boot.power2(model = Y~X + (1|schoolid), n = 1000, id = "ID", group1 = "schoolid", group2 = FALSE, data = dat)
```

```{r non parallelized}
start <- Sys.time() 
boot.power(model = mathkind~sex+minority+ses+(1|schoolid), n = 10, id = "childid", group1 = "classid", group2 = "schoolid", data = classroom)
end <- Sys.time() 
end - start
```

```{r}
start <- Sys.time()
class2 <- bootmlm(id="childid",group1="classid", group2 = "schoolid", data = classroom)
end <- Sys.time()
end - start
```

